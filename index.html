<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>–ê—É–¥–∏–æ –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
  </head>
  <style>
    body {
      overflow: hidden;
    }
    main {
      display: flex;
    }
    html,
    body,
    div,
    span,
    applet,
    object,
    iframe,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    p,
    blockquote,
    pre,
    a,
    abbr,
    acronym,
    address,
    big,
    cite,
    code,
    del,
    dfn,
    em,
    img,
    ins,
    kbd,
    q,
    s,
    samp,
    small,
    strike,
    strong,
    sub,
    sup,
    tt,
    var,
    b,
    u,
    i,
    center,
    dl,
    dt,
    dd,
    ol,
    ul,
    li,
    fieldset,
    form,
    label,
    legend,
    table,
    caption,
    tbody,
    tfoot,
    thead,
    tr,
    th,
    td,
    article,
    aside,
    canvas,
    details,
    embed,
    figure,
    figcaption,
    footer,
    header,
    hgroup,
    menu,
    nav,
    output,
    ruby,
    section,
    summary,
    time,
    mark,
    audio,
    video {
      margin: 0;
      padding: 0;
      border: 0;
      font-size: 100%;
      font: inherit;
      vertical-align: baseline;
    }
    /* HTML5 display-role reset for older browsers */
    article,
    aside,
    details,
    figcaption,
    figure,
    footer,
    header,
    hgroup,
    menu,
    nav,
    section {
      display: block;
    }
    body {
      line-height: 1;
    }
    ol,
    ul {
      list-style: none;
    }
    blockquote,
    q {
      quotes: none;
    }
    blockquote:before,
    blockquote:after,
    q:before,
    q:after {
      content: "";
      content: none;
    }
    table {
      border-collapse: collapse;
      border-spacing: 0;
    }
    html {
      height: 100%;
    }
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      flex-direction: column;
      padding: 0 !important;
    }
    button {
      left: 0 !important;
      right: 0 !important;
      top: 0 !important;
      padding: 20px;
      background-color: black;
      color: #fff;
      border-radius: 5px;
      border: 0;
      position: relative !important;
      height: 100px;
      font-size: 24px;
      width: 350px;
    }
    [type="file"] {
      /* Style the color of the message that says 'No file chosen' */
      color: #878787;
      left: auto;
      top: auto;
      position: relative !important;
    }
    [type="file"]::-webkit-file-upload-button {
      background: #535353;
      border: 2px solid #535353;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      font-size: 12px;
      outline: none;
      padding: 10px 25px;
      text-transform: uppercase;
      transition: all 1s ease;
    }

    [type="file"]::-webkit-file-upload-button:hover {
      background: #fff;
      border: 2px solid #535353;
      color: #000;
    }

    /* GENERAL STYLING OF PAGE ‚Äî NOT APPLICABLE TO EXAMPLE */
    body {
      padding: 20px;
      background: #000;
    }
  </style>
  <body style="margin: 0">
    <script>
      let fft, audioContext, isRun
      let particles = []
      const num = 3000
      const noiseScale = 0.01 / 2
      let colors
      let sound // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–≤—É–∫–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
      let lastNoiseSeedTime = 0 // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—ã–∑–æ–≤–∞ noiseSeed

      function startAudio(file) {
        audioContext = getAudioContext()
        audioContext.resume()
        // –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –∑–≤—É–∫–∞

        sound = loadSound(file, () => {
          sound.play()
        })
        fft = new p5.FFT()
        fft.setInput(sound)
        createCanvas(windowWidth, windowHeight)

        colors = [
          color(255),
          color(255, 255, 0),
          color(0, 255, 0),
          color(0, 0, 255),
          color(255, 0, 0),
        ] // –ö—Ä–∞—Å–Ω—ã–π, –∑–µ–ª—ë–Ω—ã–π, —Å–∏–Ω–∏–π, –∂—ë–ª—Ç—ã–π

        for (let i = 0; i < num; i++) {
          particles.push(createVector(random(width), random(height)))
        }

        stroke(255)
        strokeWeight(3) // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—â–∏–Ω—É —Ç–æ—á–µ–∫

        clear()
        var inputs = document.getElementsByTagName("input")
        while (inputs.length) inputs[0].parentNode.removeChild(inputs[0])
        isRun = true
      }

      function setup() {
        let fileInput = createFileInput((file) => {
          if (file.type === "audio") {
            startAudio(file.data)
          } else {
            console.log("–≠—Ç–æ –Ω–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª.")
          }
        })
        fileInput.position(10, 10)
      }

      function draw() {
        if (!isRun) return
        background(0, 10)

        let spectrum = fft.analyze()
        // console.log("üöÄ ~ file: test1.html:35 ~ draw ~ spectrum:", spectrum)
        let bass = fft.getEnergy("bass") || 0
        console.log("üöÄ ~ file: test1.html:37 ~ draw ~ bass:", bass)
        let treble = fft.getEnergy("treble") || 0
        console.log("üöÄ ~ file: test1.html:39 ~ draw ~ treble:", treble)
        let mid = fft.getEnergy("mid") || 0
        console.log("üöÄ ~ file: test1.html:41 ~ draw ~ mid:", mid)
        amp = fft.getEnergy(20, 250)
        let volume = amp / 250 // –ü–æ–ª—É—á–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –≥—Ä–æ–º–∫–æ—Å—Ç–∏
        // console.log("üöÄ ~ file: test1.html:191 ~ draw ~ volume:", volume)
        let currentTime = millis()

        let size = map(volume, 0, 1, 1, 7) // –ú–µ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä –æ—Ç 1 –¥–æ 10 –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≥—Ä–æ–º–∫–æ—Å—Ç–∏
        // strokeWeight(size < 3 ? 3 : size)

        // console.log("üöÄ ~ file: test1.html:43 ~ draw ~ volume:", volume)
        // if (bass > 250) {
        //   // console.log("üöÄ ~ file: test1.html:45 ~ draw ~ bass:", bass)
        //   // noiseSeed(Math.floor(Math.random() * 30))
        //   noiseSeed(millis())
        // }
        // if (treble > 50) {
        //   // console.log("üöÄ ~ file: test1.html:49 ~ draw ~ treble:", treble)
        //   noiseSeed(millis())
        // }
        // if (mid > 160) {
        //   // console.log("üöÄ ~ file: test1.html:53 ~ draw ~ mid:", mid)
        //   noiseSeed(millis())
        // }
        if (
          currentTime - lastNoiseSeedTime >= 800 &&
          (mid > 100 || bass > 200 || treble > 50)
        ) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à–ª–∞ –ª–∏ —Å–µ–∫—É–Ω–¥–∞
          noiseSeed(currentTime)
          let colorIndex = floor(volume * (colors.length - 1)) || 0
          // console.log(
          //   "üöÄ ~ file: test2.html:249 ~ draw ~ colorIndex:",
          //   colorIndex
          // )
          let col1 = colors[colorIndex]
          // console.log("üöÄ ~ file: test2.html:251 ~ draw ~ colors:", colors)
          // console.log("üöÄ ~ file: test2.html:250 ~ draw ~ col1:", col1)
          let col2 = colors[(colorIndex + 1) % colors.length]
          // console.log("üöÄ ~ file: test2.html:252 ~ draw ~ col2:", col2)

          // –ò—Å–ø–æ–ª—å–∑—É–µ–º lerpColor –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –º–µ–∂–¥—É –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —Ü–≤–µ—Ç–∞–º–∏
          // console.log(col1, col2, (volume * (colors.length - 1)) % 1, "dssdf")
          let col = lerpColor(col1, col2, (volume * (colors.length - 1)) % 1)

          stroke(col) // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç —Ç–æ—á–∫–∏
          lastNoiseSeedTime = currentTime // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—ã–∑–æ–≤–∞
        }
        for (let i = 0; i < num; i++) {
          let p = particles[i]
          point(p.x, p.y)
          // –í—ã–±–∏—Ä–∞–µ–º –¥–≤–∞ —Å–æ—Å–µ–¥–Ω–∏—Ö —Ü–≤–µ—Ç–∞ –∏–∑ –º–∞—Å—Å–∏–≤–∞

          let n = noise(
            p.x * noiseScale,
            p.y * noiseScale,
            frameCount * noiseScale * noiseScale
          )
          let a = TAU * n
          let s = map(amp, 20, 250, 0.5, 5)

          // –ï—Å–ª–∏ –≥—Ä–æ–º–∫–æ—Å—Ç—å –Ω–∏–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞, —Ç–æ—á–∫–∏ –¥–≤–∏–≥–∞—é—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω–æ
          let speed = volume > 1 ? (s < 1.5 ? 1.5 : s) : 1.5 // –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ—Ä–æ–≥
          // console.log("üöÄ ~ file: test1.html:54 ~ draw ~ volume:", volume)

          p.x += cos(a) * speed
          p.y += sin(a) * speed

          if (!onScreen(p)) {
            p.x = random(width)
            p.y = random(height)
          }
        }
      }

      // function mousePressed() {
      //   if (audioContext.state !== "running") {
      //     audioContext
      //       .resume()
      //       .then(() => {
      //         console.log("AudioContext running")
      //       })
      //       .catch((error) => {
      //         console.error("Error starting AudioContext:", error)
      //         // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
      //       })
      //   }
      // }

      function windowResized() {
        resizeCanvas(windowWidth, windowHeight)
      }
      function onScreen(v) {
        return v.x >= 0 && v.x <= width && v.y >= 0 && v.y <= height
      }
    </script>
  </body>
</html>
